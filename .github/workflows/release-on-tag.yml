# åŸºäºæ ‡ç­¾æ¨é€çš„è‡ªåŠ¨ Release
name: Release on Tag

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v* æ ¼å¼çš„æ ‡ç­¾æ—¶è§¦å‘

permissions:
  contents: write
  id-token: write  # ç”¨äº PyPI å¯ä¿¡å‘å¸ƒ

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´çš„ git å†å²ï¼Œç”¨äºç”Ÿæˆ changelog

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install build twine

    - name: Build package
      run: |
        python -m build

    - name: Verify package
      run: |
        python -m twine check dist/*

    - name: Get tag info
      id: tag_info
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        VERSION=${TAG_NAME#v}
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Tag: $TAG_NAME, Version: $VERSION"

    - name: Generate changelog
      id: changelog
      run: |
        # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        echo "## ğŸš€ ç‰ˆæœ¬ ${{ steps.tag_info.outputs.version }} æ›´æ–°å†…å®¹" > changelog.md
        echo "" >> changelog.md
        
        if [ -n "$PREV_TAG" ]; then
          echo "### ğŸ“ å˜æ›´è®°å½•" >> changelog.md
          echo "" >> changelog.md
          
          # æŒ‰ç±»å‹åˆ†ç»„æ˜¾ç¤ºæäº¤
          git log --pretty=format:"%s" ${PREV_TAG}..HEAD | while IFS= read -r commit; do
            case "$commit" in
              feat:*|feature:*)
                echo "- ğŸ‰ $commit" >> changelog.md
                ;;
              fix:*)
                echo "- ğŸ› $commit" >> changelog.md
                ;;
              docs:*)
                echo "- ğŸ“š $commit" >> changelog.md
                ;;
              refactor:*)
                echo "- â™»ï¸ $commit" >> changelog.md
                ;;
              test:*)
                echo "- ğŸ§ª $commit" >> changelog.md
                ;;
              chore:*|build:*)
                echo "- ğŸ”§ $commit" >> changelog.md
                ;;
              *)
                echo "- $commit" >> changelog.md
                ;;
            esac
          done
          
          echo "" >> changelog.md
          echo "**å®Œæ•´å˜æ›´**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${{ steps.tag_info.outputs.tag_name }}" >> changelog.md
        else
          echo "### ğŸŠ é¦–æ¬¡å‘å¸ƒ" >> changelog.md
          echo "" >> changelog.md
          echo "- RabbitMQ-ARQ é¡¹ç›®é¦–æ¬¡å‘å¸ƒ" >> changelog.md
          echo "- æä¾›ç±»ä¼¼ ARQ çš„ç®€æ´ API" >> changelog.md
          echo "- åŸºäº RabbitMQ çš„é«˜æ€§èƒ½å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—" >> changelog.md
        fi
        
        # æ·»åŠ å®‰è£…å’Œä½¿ç”¨ä¿¡æ¯
        echo "" >> changelog.md
        echo "## ğŸ“¦ å®‰è£…æ–¹å¼" >> changelog.md
        echo "" >> changelog.md
        echo "\`\`\`bash" >> changelog.md
        echo "pip install rabbitmq-arq==${{ steps.tag_info.outputs.version }}" >> changelog.md
        echo "\`\`\`" >> changelog.md
        
        # è®¾ç½®è¾“å‡º
        {
          echo "changelog<<EOF"
          cat changelog.md
          echo "EOF"
        } >> $GITHUB_OUTPUT

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-dists
        path: dist/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag_info.outputs.tag_name }}
        name: Release ${{ steps.tag_info.outputs.tag_name }}
        body: ${{ steps.changelog.outputs.changelog }}
        draft: false
        prerelease: false
        files: |
          dist/*
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Notify GitHub Release success
      if: success()
      run: |
        echo "ğŸ‰ Release ${{ steps.tag_info.outputs.tag_name }} åˆ›å»ºæˆåŠŸï¼"
        echo "ğŸ“¦ åŒ…å·²ä¸Šä¼ åˆ° GitHub Release"

  pypi-publish:
    runs-on: ubuntu-latest
    needs: build-and-release
    permissions:
      id-token: write  # é‡è¦ï¼šç”¨äºå¯ä¿¡å‘å¸ƒ

    # ä½¿ç”¨ç¯å¢ƒä¿æŠ¤
    environment:
      name: pypi
      url: https://pypi.org/project/rabbitmq-arq

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-dists
        path: dist/

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        verbose: true
        print-hash: true
        skip-existing: false

    - name: Notify PyPI success
      if: success()
      run: |
        echo "ğŸ åŒ…å·²æˆåŠŸå‘å¸ƒåˆ° PyPIï¼"
        echo "ğŸ“¦ å¯ä»¥é€šè¿‡ 'pip install rabbitmq-arq' å®‰è£…æœ€æ–°ç‰ˆæœ¬"